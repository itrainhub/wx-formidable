const LINE_BREAK="\r\n",genBoundary=()=>{var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let t="----XiaoMingFormData";for(let e=0,r=a.length;e<16;e++)t+=a[Math.floor(Math.random()*r)];return t},stringToBuffer=r=>{const a=[];var t=r.length;for(let e=0;e<t;e++)a.push(r.charCodeAt(e));return new Uint8Array(a)},readFile=e=>new Promise((r,a)=>{wx.getFileSystemManager().readFile({filePath:e,success:e=>r(e.data),fail:e=>a(e)})}),genArrayBuffer=async e=>{var{boundary:e,files:r}=e,a=`--${e}${LINE_BREAK}`,e=`--${e}--${LINE_BREAK}`;const t=[];for(let e=0;e<r.length;e++){var{filePath:n,filename:o,name:s}=r[e],o=`${a}`+`Content-Disposition: form-data; name="${s}"; filename="${o=o||(null===(s=/(?:(?!\/).)*$/.exec(n))||void 0===s?void 0:s[0])}"${LINE_BREAK}`+`Content-Type: application/octet-stream${LINE_BREAK}${LINE_BREAK}`;t.push(stringToBuffer(o));n=await readFile(n);t.push(new Uint8Array(n)),t.push(stringToBuffer(LINE_BREAK))}t.push(stringToBuffer(e));e=t.reduce((e,r)=>e+r.length,0);const i=new Uint8Array(e);let l=0;return t.forEach(e=>{e.forEach((e,r)=>i[l+r]=e),l+=e.length}),i.buffer},wxFormidable=async({url:e,method:t="POST",header:n={},success:r,fail:a,...o})=>{const s=genBoundary(),i=await genArrayBuffer({boundary:s,...o}),l=new Promise((r,a)=>{wx.request({url:e,method:t,header:{...n,"Content-Type":"multipart/form-data; boundary="+s},data:i,success:e=>200===e.statusCode?r(e.data):a(e),fail:e=>a(e)})});return r||a?l.then(e=>r&&r(e)).catch(e=>a&&a(e)):l};module.exports=wxFormidable;