const LINE_BREAK="\r\n",genBoundary=()=>{var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let a="----XiaoMingFormData";for(let e=0,t=r.length;e<16;e++)a+=r[Math.floor(Math.random()*t)];return a},stringToBuffer=t=>{const r=[];var a=t.length;for(let e=0;e<a;e++)r.push(t.charCodeAt(e));return new Uint8Array(r)},readFile=e=>new Promise((t,r)=>{wx.getFileSystemManager().readFile({filePath:e,success:e=>t(e.data),fail:e=>r(e)})}),wxFormidable=async({url:e,files:t,method:a="POST",header:n={},success:r,fail:o})=>{const s=genBoundary();var i=`--${s}${LINE_BREAK}`,l=`--${s}--${LINE_BREAK}`;const f=[];for(let e=0;e<t.length;e++){var{filePath:u,filename:h,name:c}=t[e];const n=`${i}`+`Content-Disposition: form-data; name="${c}"; filename="${h}"${LINE_BREAK}`+`Content-Type: application/octet-stream${LINE_BREAK}${LINE_BREAK}`;f.push(stringToBuffer(n));u=await readFile(u);f.push(new Uint8Array(u)),f.push(stringToBuffer(LINE_BREAK))}f.push(stringToBuffer(l));l=f.reduce((e,t)=>e+t.length,0);const d=new Uint8Array(l);let m=0;f.forEach(e=>{e.forEach((e,t)=>d[m+t]=e),m+=e.length});const E=new Promise((t,r)=>{wx.request({url:e,method:a,header:{...n,"Content-Type":"multipart/form-data; boundary="+s},data:d.buffer,success:e=>200===e.statusCode?t(e.data):r(e),fail:e=>r(e)})});return r||o?E.then(e=>r&&r(e)).catch(e=>o&&o(e)):E};module.exports=wxFormidable;