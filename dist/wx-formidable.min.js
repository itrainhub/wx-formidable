const LINE_BREAK="\r\n",genBoundary=()=>{var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let t="----XiaoMingFormData";for(let e=0,r=a.length;e<16;e++)t+=a[Math.floor(Math.random()*r)];return t},stringToBuffer=r=>{const a=[];var t=r.length;for(let e=0;e<t;e++)a.push(r.charCodeAt(e));return new Uint8Array(a)},readFile=e=>new Promise((r,a)=>{wx.getFileSystemManager().readFile({filePath:e,success:e=>r(e.data),fail:e=>a(e)})}),genArrayBuffer=async e=>{var{boundary:e,fields:a,files:t}=e,n=`--${e}${LINE_BREAK}`,e=`--${e}--${LINE_BREAK}`;const o=[];for(let e=0,r=a.length;e<r;e++){var{name:s,value:i}=a[e],i=n+`Content-Disposition: form-data; name="${s}"${LINE_BREAK}${LINE_BREAK}`+`${i}${LINE_BREAK}`;o.push(stringToBuffer(i))}for(let e=0,r=t.length;e<r;e++){var{filePath:l,fileName:f,name:u}=t[e],f=n+`Content-Disposition: form-data; name="${u}"; filename="${f=f||(null===(u=/(?:(?!\/).)*$/.exec(l))||void 0===u?void 0:u[0])}"${LINE_BREAK}`+`Content-Type: application/octet-stream${LINE_BREAK}${LINE_BREAK}`;o.push(stringToBuffer(f));l=await readFile(l);o.push(new Uint8Array(l)),o.push(stringToBuffer(LINE_BREAK))}o.push(stringToBuffer(e));e=o.reduce((e,r)=>e+r.length,0);const d=new Uint8Array(e);let h=0;return o.forEach(e=>{e.forEach((e,r)=>d[h+r]=e),h+=e.length}),d.buffer},wxFormidable=async({url:e,method:t="POST",header:n={},success:r,fail:a,...o})=>{const s=genBoundary(),i=await genArrayBuffer({boundary:s,...o}),l=new Promise((r,a)=>{wx.request({url:e,method:t,header:{...n,"Content-Type":"multipart/form-data; boundary="+s},data:i,success:e=>200===e.statusCode?r(e.data):a(e),fail:e=>a(e)})});return r||a?l.then(e=>r&&r(e)).catch(e=>a&&a(e)):l};module.exports=wxFormidable;