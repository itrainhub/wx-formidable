const LINE_BREAK="\r\n",genBoundary=()=>{var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let t="----XiaoMingFormData";for(let e=0,r=a.length;e<16;e++)t+=a[Math.floor(Math.random()*r)];return t},stringToBuffer=t=>{var n=t.length;let o=-1;const i=new Uint8Array(3*n);for(let e=0,r=0,a=0;a!==n;){if(e=t.charCodeAt(a),a+=1,55296<=e&&e<=56319){if(a===n){i[o+=1]=239,i[o+=1]=191,i[o+=1]=189;break}if(!(56320<=(r=t.charCodeAt(a))&&r<=57343)){i[o+=1]=239,i[o+=1]=191,i[o+=1]=189;continue}if(e=1024*(e-55296)+r-56320+65536,a+=1,65535<e){i[o+=1]=240|e>>>18,i[o+=1]=128|e>>>12&63,i[o+=1]=128|e>>>6&63,i[o+=1]=128|63&e;continue}}e<=127?i[o+=1]=0|e:(e<=2047?i[o+=1]=192|e>>>6:(i[o+=1]=224|e>>>12,i[o+=1]=128|e>>>6&63),i[o+=1]=128|63&e)}return i.subarray(0,o+1)},readFile=e=>new Promise((r,a)=>{wx.getFileSystemManager().readFile({filePath:e,success:e=>r(e.data),fail:e=>a(e)})}),genArrayBuffer=async e=>{var{boundary:e,fields:a,files:t}=e,n=`--${e}${LINE_BREAK}`,e=`--${e}--${LINE_BREAK}`;const o=[];for(let e=0,r=a.length;e<r;e++){var{name:i,value:s}=a[e],s=n+`Content-Disposition: form-data; name="${i}"${LINE_BREAK}${LINE_BREAK}`+`${s}${LINE_BREAK}`;o.push(stringToBuffer(s))}for(let e=0,r=t.length;e<r;e++){var{filePath:f,fileName:l,name:u}=t[e],l=n+`Content-Disposition: form-data; name="${u}"; filename="${l=l||(null===(u=/(?:(?!\/).)*$/.exec(f))||void 0===u?void 0:u[0])}"${LINE_BREAK}`+`Content-Type: application/octet-stream${LINE_BREAK}${LINE_BREAK}`;o.push(stringToBuffer(l));f=await readFile(f);o.push(new Uint8Array(f)),o.push(stringToBuffer(LINE_BREAK))}o.push(stringToBuffer(e));e=o.reduce((e,r)=>e+r.length,0);const d=new Uint8Array(e);let c=0;return o.forEach(e=>{e.forEach((e,r)=>d[c+r]=e),c+=e.length}),d.buffer},wxFormidable=async({url:e,method:t="POST",header:n={},success:r,fail:a,...o})=>{const i=genBoundary(),s=await genArrayBuffer({boundary:i,...o}),f=new Promise((r,a)=>{wx.request({url:e,method:t,header:{...n,"Content-Type":"multipart/form-data; boundary="+i},data:s,success:e=>200===e.statusCode?r(e.data):a(e),fail:e=>a(e)})});return r||a?f.then(e=>r&&r(e)).catch(e=>a&&a(e)):f};module.exports=wxFormidable;